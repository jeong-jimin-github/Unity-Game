name: Automated Build ⭐(test)

on:
  push:
    branches: [ main ]
  workflow_dispatch: # GitHub Actions를 수동으로 실행할 수 있도록 추가

permissions:
  contents: write

jobs:
  build:
    name: 💻 Build on Windows for Windows and macOS
    runs-on: windows-latest

    steps:
      - name: Clone Gogs repository
        run: |
          git clone --branch master http://oauth2:${{ secrets.GOGS_TOKEN }}@112.147.160.124:8080/Kuuhaku/Unity-Game.git source
          cd source
          git lfs pull

      - uses: actions/cache@v4
        with:
          path: source/Library
          key: Library-${{ hashFiles('source/Assets/**', 'source/Packages/**', 'source/ProjectSettings/**') }}
          restore-keys: |
            Library-

      # Windows 빌드
      - name: Build for Windows
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          allowDirtyBuild: true
          projectPath: source
          targetPlatform: StandaloneWindows64
          buildPath: Build/Windows

      # macOS 빌드
      - name: Build for macOS
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          allowDirtyBuild: true
          projectPath: source
          targetPlatform: StandaloneOSX
          buildPath: Build/MacOS

      # Windows 빌드 결과 압축
      - name: Compress Windows build
        shell: pwsh
        run: |
          Compress-Archive -Path Build\Windows\* -DestinationPath Windows_Build.zip

      # macOS 빌드 결과 압축
      - name: Compress macOS build
        shell: pwsh
        run: |
          Compress-Archive -Path Build\MacOS\* -DestinationPath MacOS_Build.zip

      # 모든 빌드 아티팩트를 업로드
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Build Artifacts
          path: |
            Windows_Build.zip
            MacOS_Build.zip

      # GitHub Release 생성
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Windows_Build.zip
            MacOS_Build.zip
          tag_name: v1.0.${{ github.run_number }}
          release_name: "Release v1.0.${{ github.run_number }}"
          body: |
            - Windows 빌드: Windows_Build.zip
            - macOS 빌드: MacOS_Build.zip
            자동 생성된 Windows 및 macOS 빌드입니다.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}