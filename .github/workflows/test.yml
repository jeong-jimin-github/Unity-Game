name: Automated Build â­(test)

on:
  push:
    branches: [ main ]
  workflow_dispatch: # GitHub Actionsë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ì¶”ê°€

permissions:
  contents: write

jobs:
  build:
    name: ğŸ’» Build on Windows for Windows and macOS
    runs-on: windows-latest

    steps:
      - name: Clone Gogs repository
        run: |
          git clone --branch master http://oauth2:${{ secrets.GOGS_TOKEN }}@112.147.160.124:8080/Kuuhaku/Unity-Game.git source
          cd source
          git lfs pull

      - uses: actions/cache@v4
        with:
          path: source/Library
          key: Library-${{ hashFiles('source/Assets/**', 'source/Packages/**', 'source/ProjectSettings/**') }}
          restore-keys: |
            Library-

      # Windows ë¹Œë“œ
      - name: Build for Windows
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          allowDirtyBuild: true
          projectPath: source
          targetPlatform: StandaloneWindows64
          buildPath: Build/Windows

      # macOS ë¹Œë“œ
      - name: Build for macOS
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          allowDirtyBuild: true
          projectPath: source
          targetPlatform: StandaloneOSX
          buildPath: Build/MacOS

      # Windows ë¹Œë“œ ê²°ê³¼ ì••ì¶•
      - name: Compress Windows build
        shell: pwsh
        run: |
          Compress-Archive -Path Build\Windows\* -DestinationPath Windows_Build.zip

      # macOS ë¹Œë“œ ê²°ê³¼ ì••ì¶•
      - name: Compress macOS build
        shell: pwsh
        run: |
          Compress-Archive -Path Build\MacOS\* -DestinationPath MacOS_Build.zip

      # ëª¨ë“  ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ë¥¼ ì—…ë¡œë“œ
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Build Artifacts
          path: |
            Windows_Build.zip
            MacOS_Build.zip

      # GitHub Release ìƒì„±
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Windows_Build.zip
            MacOS_Build.zip
          tag_name: v1.0.${{ github.run_number }}
          release_name: "Release v1.0.${{ github.run_number }}"
          body: |
            - Windows ë¹Œë“œ: Windows_Build.zip
            - macOS ë¹Œë“œ: MacOS_Build.zip
            ìë™ ìƒì„±ëœ Windows ë° macOS ë¹Œë“œì…ë‹ˆë‹¤.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}